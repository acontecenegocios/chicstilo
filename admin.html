<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Admin Chicstilo</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<style>

body{
font-family: Arial;
background:#f4f4f4;
padding:15px;
}

.container{
background:white;
padding:15px;
border-radius:10px;
max-width:500px;
margin:auto;
}

input, textarea{
width:100%;
padding:12px;
margin:5px 0;
}

button{
background:black;
color:white;
padding:15px;
border:none;
width:100%;
margin-top:5px;
}

.produto{
background:#eee;
padding:10px;
margin-top:10px;
border-radius:5px;
}

.excluir{
background:red;
margin-top:5px;
}

</style>

</head>
<body>

<div class="container">

<h2>Novo Produto</h2>

<input id="marca" placeholder="Marca">
<input id="tamanho" placeholder="Tamanho">
<input id="cor" placeholder="Cor">
<input id="preco" placeholder="Preço">
<textarea id="observacoes" placeholder="Observações"></textarea>

<input type="file" id="foto">

<button onclick="salvar()">Salvar Produto</button>

<h2>Produtos</h2>
<div id="lista"></div>

</div>

<script>

const supabaseClient = supabase.createClient(
"https://pupqmtogotalkrppzkzd.supabase.co",
"sb_publishable_mEb4-SGlEs8Sq7IM_UQl-Q_P-Yy1O4V"
);

async function gerarCodigo(){

const { data } = await supabaseClient
.from("produtos")
.select("id")
.order("id",{ascending:false})
.limit(1);

if(data.length==0) return "CH-0001";

let numero = data[0].id + 1;

return "CH-" + numero.toString().padStart(4,"0");

}

async function uploadFoto(file){

if(!file) return "";

const nome = Date.now() + ".jpg";

const { error } = await supabaseClient.storage
.from("fotos")
.upload(nome,file);

if(error){
alert(error.message);
return "";
}

const { data } = supabaseClient.storage
.from("fotos")
.getPublicUrl(nome);

return data.publicUrl;

}

async function salvar(){

const codigo = await gerarCodigo();

const marca = document.getElementById("marca").value;
const tamanho = document.getElementById("tamanho").value;
const cor = document.getElementById("cor").value;
const preco = document.getElementById("preco").value;
const observacoes = document.getElementById("observacoes").value;

const file = document.getElementById("foto").files[0];

let foto_url = "";

if(file){
foto_url = await uploadFoto(file);
}

await supabaseClient
.from("produtos")
.insert([{
codigo,
marca,
tamanho,
cor,
preco,
observacoes,
foto_url
}]);

alert("Produto salvo!");

carregar();

}

async function excluir(id){

if(!confirm("Excluir produto?")) return;

await supabaseClient
.from("produtos")
.delete()
.eq("id",id);

carregar();

}

async function carregar(){

const { data } = await supabaseClient
.from("produtos")
.select("*")
.order("id",{ascending:false});

const lista = document.getElementById("lista");

lista.innerHTML="";

data.forEach(p=>{

lista.innerHTML+=`

<div class="produto">

<b>${p.codigo}</b><br>
${p.marca}<br>
${p.tamanho} - ${p.cor}<br>

<button class="excluir" onclick="excluir(${p.id})">
Excluir
</button>

</div>

`;

});

}

carregar();

</script>

</body>
</html>
